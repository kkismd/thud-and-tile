# Phase 2 CLIç§»è¡Œæˆ¦ç•¥: å®‰å…¨ãªæ®µéšçš„ç§»è¡Œè¨ˆç”»

**ä½œæˆæ—¥**: 2025å¹´10æœˆ7æ—¥  
**ç‰¹åŒ–å¯¾è±¡**: ãƒ•ã‚§ãƒ¼ã‚º 2ã€ŒLayer 2 CLIå®Ÿè£…ã€å°‚é–€æˆ¦ç•¥  
**ç›®çš„**: æ—¢å­˜CLIæ©Ÿèƒ½ã®å®‰å…¨ãªç§»è¡Œã¨ãƒ†ã‚¹ãƒˆä¿è­·

**ğŸ“‹ é–¢é€£æ–‡æ›¸**: 
- åŒ…æ‹¬çš„ãƒªã‚¹ã‚¯åˆ†æ: `MIGRATION_RISK_COMPREHENSIVE_ANALYSIS.md`
- ãƒ•ã‚§ãƒ¼ã‚º2è¨ˆç”»æ”¹è¨‚: `PHASE2_PLAN_REVISION.md`

---

## ğŸš¨ **éå»ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†æ**

### **å…¸å‹çš„ãªå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³**
1. **æ–°APIä½œæˆ â†’ æ—¢å­˜å®Ÿè£…ä¸€æ‹¬ç½®æ› â†’ ãƒ†ã‚¹ãƒˆå¤§é‡å¤±æ•— â†’ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
2. **æ ¹æœ¬åŸå› **: æ—¢å­˜ã®ä¾å­˜é–¢ä¿‚ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è€ƒæ…®ã›ãšã«ä¸€æ‹¬å¤‰æ›´
3. **å½±éŸ¿ç¯„å›²**: ç¾åœ¨92å€‹ã®ãƒ†ã‚¹ãƒˆãŒå…¨ã¦é€šéä¸­ â†’ ä¸€æ‹¬å¤‰æ›´ã§å¤§é‡å¤±æ•—ã®ãƒªã‚¹ã‚¯

---

## ğŸ¯ **CLIç§»è¡Œæˆ¦ç•¥ã®ç‰¹åŒ–ç¯„å›²**

### **å¯¾è±¡ç¯„å›²ï¼ˆCLI Layerå°‚é–€ï¼‰**
```rust
main.rs (ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ)
â”œâ”€â”€ crossterm (terminalåˆ¶å¾¡) â† ç§»è¡Œå¯¾è±¡
â”œâ”€â”€ render.rs (æç”»ã‚·ã‚¹ãƒ†ãƒ ) â† ç§»è¡Œå¯¾è±¡  
â”œâ”€â”€ game_input.rs (å…¥åŠ›å‡¦ç†) â† ç§»è¡Œå¯¾è±¡
â”œâ”€â”€ scheduler.rs (æ™‚é–“ç®¡ç†) â† ç§»è¡Œå¯¾è±¡
â”œâ”€â”€ cli_bridge.rs (CLIãƒ–ãƒªãƒƒã‚¸) â† ç§»è¡Œå¯¾è±¡
â””â”€â”€ core/ (å…±é€šãƒ­ã‚¸ãƒƒã‚¯) â† Phase 1å®Œäº†ã€Layer 1é©åˆæ¸ˆã¿
```

### **å¯¾è±¡å¤–ï¼ˆä»–æ–‡æ›¸ã§ç®¡ç†ï¼‰**
- **WASMå¢ƒç•Œãƒªã‚¹ã‚¯** â†’ `MIGRATION_RISK_COMPREHENSIVE_ANALYSIS.md`
- **JavaScriptçµ±åˆ** â†’ `MIGRATION_RISK_COMPREHENSIVE_ANALYSIS.md`  
- **Feature Flagç®¡ç†** â†’ `MIGRATION_RISK_COMPREHENSIVE_ANALYSIS.md`
- **Core Moduleå¤‰æ›´** â†’ Phase 1å®Œäº†æ¸ˆã¿

---

## ğŸ›¡ï¸ **ãƒªã‚¹ã‚¯å¯¾å¿œæˆ¦ç•¥**

### **æˆ¦ç•¥ 1: æ®µéšçš„ç§»è¡Œï¼ˆStrangler Fig Patternï¼‰**
æ–°ã—ã„Layer 2ã‚’æ—¢å­˜CLIã¨**ä¸¦è¡Œç¨¼åƒ**ã•ã›ã€æ®µéšçš„ã«ç½®æ›

```
ãƒ•ã‚§ãƒ¼ã‚º 2A: Layer 2åŸºç›¤ä½œæˆï¼ˆãƒªã‚¹ã‚¯ãªã—ï¼‰
â”œâ”€â”€ src/cli/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
â”œâ”€â”€ Layer 2åŸºæœ¬æ§‹é€ å®Ÿè£…
â””â”€â”€ æ—¢å­˜CLIæ©Ÿèƒ½ã¯å®Œå…¨ä¿æŒï¼ˆå¤‰æ›´ãªã—ï¼‰

ãƒ•ã‚§ãƒ¼ã‚º 2B: æ©Ÿèƒ½åˆ¥æ®µéšç§»è¡Œï¼ˆä½ãƒªã‚¹ã‚¯ï¼‰
â”œâ”€â”€ 1æ©Ÿèƒ½ãšã¤ç§»è¡Œ
â”œâ”€â”€ å„ç§»è¡Œå¾Œã«å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
â””â”€â”€ å¤±æ•—æ™‚ã¯è©²å½“æ©Ÿèƒ½ã®ã¿ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

ãƒ•ã‚§ãƒ¼ã‚º 2C: æœ€çµ‚çµ±åˆï¼ˆç¢ºèªæ¸ˆã¿ï¼‰
â”œâ”€â”€ å…¨æ©Ÿèƒ½ç§»è¡Œå®Œäº†å¾Œã®çµ±åˆ
â””â”€â”€ æ—§å®Ÿè£…å‰Šé™¤
```

### **æˆ¦ç•¥ 2: ãƒ†ã‚¹ãƒˆé§†å‹•ç§»è¡Œï¼ˆTest-First Migrationï¼‰**
ç§»è¡Œå‰ã«æ–°Layer 2ç”¨ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆã—ã€æ—¢å­˜ãƒ†ã‚¹ãƒˆã¨ã®æ•´åˆæ€§ç¢ºä¿

```
æ‰‹é †:
1. ç§»è¡Œå¯¾è±¡æ©Ÿèƒ½ã®æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚’è¤‡è£½
2. Layer 2 APIå‘ã‘ã«èª¿æ•´
3. Layer 2å®Ÿè£… â†’ æ–°ãƒ†ã‚¹ãƒˆé€šéç¢ºèª
4. æ—¢å­˜å®Ÿè£…ã‚’æ®µéšçš„ã«æ–°å®Ÿè£…ã«ç½®æ›
5. å…¨ãƒ†ã‚¹ãƒˆï¼ˆæ—§+æ–°ï¼‰é€šéç¢ºèª
```

### **æˆ¦ç•¥ 3: å¾Œæ–¹äº’æ›APIï¼ˆBackward Compatibilityï¼‰**
æ—¢å­˜APIã‚’ç¶­æŒã—ã¤ã¤ã€å†…éƒ¨å®Ÿè£…ã®ã¿Layer 2ã«ç§»è¡Œ

```rust
// æ—¢å­˜APIä¿æŒï¼ˆãƒ†ã‚¹ãƒˆå¤‰æ›´ãªã—ï¼‰
pub fn render_game_state(state: &GameState) {
    // å†…éƒ¨ã§Layer 2å‘¼ã³å‡ºã—
    cli::renderer::render(state);
}

// æ–°Layer 2 APIï¼ˆæ®µéšçš„å°å…¥ï¼‰
pub mod cli {
    pub mod renderer {
        pub fn render(state: &GameState) {
            // Layer 2å®Ÿè£…
        }
    }
}
```

---

## ğŸ“‹ **è©³ç´°ç§»è¡Œè¨ˆç”»**

### **ãƒ•ã‚§ãƒ¼ã‚º 2A: å®‰å…¨ãªåŸºç›¤æ§‹ç¯‰ï¼ˆ0.3æ—¥ï¼‰**
```
ç›®çš„: æ—¢å­˜æ©Ÿèƒ½ã«å½±éŸ¿ã‚’ä¸ãˆãšã«Layer 2åŸºç›¤ã‚’æº–å‚™

å®Ÿè£…:
1. src/cli/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
2. CLI LayeråŸºæœ¬æ§‹é€ å®šç¾©
3. Layer 1ã¨ã®æ¥ç¶šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä½œæˆ

ãƒªã‚¹ã‚¯: ã‚¼ãƒ­ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãªã—ï¼‰
æ¤œè¨¼: cargo test â†’ 92/92 passed ç¶­æŒ
```

### **ãƒ•ã‚§ãƒ¼ã‚º 2B-1: æç”»æ©Ÿèƒ½ç§»è¡Œï¼ˆ0.2æ—¥ï¼‰**
```
å¯¾è±¡: render.rs ã®æç”»æ©Ÿèƒ½
ç†ç”±: ä»–æ©Ÿèƒ½ã¸ã®ä¾å­˜ãŒå°‘ãªã„ç‹¬ç«‹æ€§ã®é«˜ã„æ©Ÿèƒ½

æ‰‹é †:
1. src/cli/renderer.rs ä½œæˆ
2. render.rs ã®æ©Ÿèƒ½ã‚’Layer 2ã«å®Ÿè£…
3. å¾Œæ–¹äº’æ›APIã§æ—¢å­˜å‘¼ã³å‡ºã—ã‚’ç¶­æŒ
4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèª (92/92 passed)

ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: render.rså¾©å…ƒã®ã¿ï¼ˆå½±éŸ¿å±€æ‰€åŒ–ï¼‰
```

### **ãƒ•ã‚§ãƒ¼ã‚º 2B-2: å…¥åŠ›æ©Ÿèƒ½ç§»è¡Œï¼ˆ0.2æ—¥ï¼‰**
```
å¯¾è±¡: game_input.rs ã®å…¥åŠ›å‡¦ç†
å‰æ: ãƒ•ã‚§ãƒ¼ã‚º 2B-1 å®Œäº†ç¢ºèªæ¸ˆã¿

æ‰‹é †:
1. src/cli/input.rs ä½œæˆ
2. æ—¢å­˜InputProviderã‚’Layer 2ã§å†å®Ÿè£…
3. å¾Œæ–¹äº’æ›APIã§æ—¢å­˜å‘¼ã³å‡ºã—ã‚’ç¶­æŒ
4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèª

ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: game_input.rså¾©å…ƒ
```

### **ãƒ•ã‚§ãƒ¼ã‚º 2B-3: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°æ©Ÿèƒ½ç§»è¡Œï¼ˆ0.2æ—¥ï¼‰**
```
å¯¾è±¡: scheduler.rs ã®æ™‚é–“ç®¡ç†
å‰æ: ãƒ•ã‚§ãƒ¼ã‚º 2B-1,2 å®Œäº†ç¢ºèªæ¸ˆã¿

æ‰‹é †:
1. src/cli/scheduler.rs ä½œæˆ
2. æ™‚é–“ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã‚’Layer 2ã§å†å®Ÿè£…
3. å¾Œæ–¹äº’æ›APIã§ç¶­æŒ
4. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèª

ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: scheduler.rså¾©å…ƒ
```

### **ãƒ•ã‚§ãƒ¼ã‚º 2C: çµ±åˆã¨æœ€é©åŒ–ï¼ˆ0.1æ—¥ï¼‰**
```
å‰æ: å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»è¡Œå®Œäº†ã€92ãƒ†ã‚¹ãƒˆé€šéç¢ºèªæ¸ˆã¿

æ‰‹é †:
1. main.rs ã§Layer 2 APIã‚’ç›´æ¥å‘¼ã³å‡ºã—ã«å¤‰æ›´
2. æ—§ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
3. æœ€çµ‚ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèª

ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: gitã«ã‚ˆã‚‹å…¨å¤‰æ›´å–ã‚Šæ¶ˆã—
```

---

## ğŸ§ª **ãƒ†ã‚¹ãƒˆä¿è­·æˆ¦ç•¥**

### **ç§»è¡Œå‰ãƒ†ã‚¹ãƒˆç¢ºä¿**
```bash
# ç§»è¡Œå‰ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç¢ºä¿
cargo test > baseline_test_results.txt
git tag phase2-migration-start

# å„ç§»è¡Œã‚¹ãƒ†ãƒƒãƒ—ã§ã®æ¤œè¨¼
function verify_migration_step() {
    cargo test || {
        echo "ãƒ†ã‚¹ãƒˆå¤±æ•— - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ"
        git reset --hard HEAD~1
        return 1
    }
}
```

### **ä¸¦è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**
```rust
// æ—§å®Ÿè£…ãƒ†ã‚¹ãƒˆä¿æŒ
#[cfg(test)]
mod legacy_tests {
    // æ—¢å­˜ã®77å€‹ã®CLIãƒ†ã‚¹ãƒˆ
}

// æ–°Layer 2ãƒ†ã‚¹ãƒˆæ®µéšè¿½åŠ 
#[cfg(test)]
mod layer2_tests {
    // Layer 2å®Ÿè£…ç”¨ã®æ–°ãƒ†ã‚¹ãƒˆ
}
```

### **å›å¸°ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–**
```bash
# å„æ©Ÿèƒ½ç§»è¡Œå¾Œã®è‡ªå‹•æ¤œè¨¼
for component in renderer input scheduler; do
    echo "ç§»è¡Œä¸­: $component"
    # ç§»è¡Œå®Ÿè£…
    cargo test || {
        echo "å¤±æ•—: $componentç§»è¡Œã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"
        git checkout -- src/$component.rs
        continue
    }
    echo "æˆåŠŸ: $componentç§»è¡Œå®Œäº†"
done
```

---

## âš¡ **ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»**

### **æ®µéšåˆ¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
```
ãƒ¬ãƒ™ãƒ« 1: å€‹åˆ¥æ©Ÿèƒ½ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
â”œâ”€â”€ å¯¾è±¡: å˜ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»è¡Œå¤±æ•—
â”œâ”€â”€ æ–¹æ³•: git checkout -- src/cli/component.rs
â””â”€â”€ å½±éŸ¿: è©²å½“æ©Ÿèƒ½ã®ã¿

ãƒ¬ãƒ™ãƒ« 2: ãƒ•ã‚§ãƒ¼ã‚ºå…¨ä½“ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯  
â”œâ”€â”€ å¯¾è±¡: ãƒ•ã‚§ãƒ¼ã‚ºå†…è¤‡æ•°å¤±æ•—
â”œâ”€â”€ æ–¹æ³•: git reset --hard phase2-migration-start
â””â”€â”€ å½±éŸ¿: ãƒ•ã‚§ãƒ¼ã‚º 2å…¨ä½“

ãƒ¬ãƒ™ãƒ« 3: å®Œå…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
â”œâ”€â”€ å¯¾è±¡: äºˆæœŸã›ã¬ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“å½±éŸ¿
â”œâ”€â”€ æ–¹æ³•: git reset --hard origin/main
â””â”€â”€ å½±éŸ¿: å…¨å¤‰æ›´å–ã‚Šæ¶ˆã—
```

---

## ğŸ“Š **æˆåŠŸæŒ‡æ¨™ã¨æ¤œè¨¼**

### **ç§»è¡Œå®Œäº†æ¡ä»¶**
1. âœ… **å…¨ãƒ†ã‚¹ãƒˆé€šé**: 92/92 passed ç¶­æŒ
2. âœ… **æ©Ÿèƒ½ç­‰ä¾¡æ€§**: CLIç‰ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å®Œå…¨ä¿æŒ
3. âœ… **ã‚³ãƒ¼ãƒ‰å“è³ª**: Layeråˆ†é›¢ã«ã‚ˆã‚‹ä¾å­˜é–¢ä¿‚æ•´ç†
4. âœ… **ä¿å®ˆæ€§å‘ä¸Š**: Layer 2ç‹¬ç«‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–

### **å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹**
```rust
// ãƒ†ã‚¹ãƒˆé€šéç‡
assert_eq!(test_pass_rate, 100%);

// Layeråˆ†é›¢å“è³ª
assert!(layer1_dependencies.is_empty_of_cli_specific());
assert!(layer2_dependencies.is_empty_of_wasm_specific());

// å¾Œæ–¹äº’æ›æ€§
assert_eq!(cli_user_experience, original_experience);
```

---

## ğŸ¯ **å®Ÿè£…é †åºæœ€é©åŒ–**

### **ä¾å­˜é–¢ä¿‚æœ€å°åŒ–é †åº**
1. **renderer** (ç‹¬ç«‹æ€§é«˜) â†’ ãƒªã‚¹ã‚¯æœ€å°
2. **input** (rendererä¾å­˜ãªã—) â†’ ãƒªã‚¹ã‚¯ä½
3. **scheduler** (å…¨ä½“èª¿æ•´å¿…è¦) â†’ ãƒªã‚¹ã‚¯ä¸­
4. **çµ±åˆ** (å…¨ä¾å­˜é–¢ä¿‚èª¿æ•´) â†’ ãƒªã‚¹ã‚¯ç®¡ç†æ¸ˆã¿

### **å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ**
```
ã‚¹ãƒ†ãƒƒãƒ— 1å®Œäº† â†’ æç”»ãƒ†ã‚¹ãƒˆç¢ºèª
ã‚¹ãƒ†ãƒƒãƒ— 2å®Œäº† â†’ å…¥åŠ›ãƒ†ã‚¹ãƒˆç¢ºèª
ã‚¹ãƒ†ãƒƒãƒ— 3å®Œäº† â†’ çµ±åˆãƒ†ã‚¹ãƒˆç¢ºèª
æœ€çµ‚å®Œäº† â†’ å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆç¢ºèª
```

**çµè«–**: æ®µéšçš„ç§»è¡Œ + ãƒ†ã‚¹ãƒˆé§†å‹• + å¾Œæ–¹äº’æ›æ€§ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆå¤±æ•—ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãŸãƒ•ã‚§ãƒ¼ã‚º 2å®Ÿè£…è¨ˆç”»ã‚’ç¢ºç«‹ã€‚