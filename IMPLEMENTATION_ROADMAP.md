# 次フェーズ着手ガイド: CLIレンダラー再設計トラッキング戦略

**更新日**: 2025年10月8日  
**現在の状況**: Phase 2Cまで完了。Phase 2Dでのターミナルイベントループ試作をWIPブランチへ退避し、安定ラインを `phase2c-completed` に復元済み。  
**目的**: CLIレンダラー再設計 (Phase 2D) を段階的かつ安全に完了させるための実装ガイドと進捗トラッキング手法を整理する。

---

## 🎯 現在の状況サマリー

### ✅ 完了済み
- Phase 1: Core層の固定長化・WASM境界安全化
- Phase 2A: CLI Layer基盤構築、3層アーキテクチャ確立
- Phase 2B: CLI入力マッピング実装と安定化
- Phase 2C: CLI描画システム統合作業の完了 (タグ `phase2c-completed`)

### 🔄 再設計対象 (Phase 2D)
- 目的: CLI描画システムをゼロベースで再構築し、イベントループ・差分描画・テスト容易性を向上させる
- 現状: 試作コードは `phase2d-wip` に保管。メインラインは安定状態
- リスク: レンダリング制御の複雑化、差分描画の再実装、端末依存挙動

---

## 🚀 Phase 2D 再設計マイルストーン

| マイルストーン | ゴール | 成果物 | 完了条件 |
| --- | --- | --- | --- |
| 1. レンダリング契約定義 | 入出力・エラー・エッジケースの整理 | 設計ノート／ドキュメント追記 | 主要ユースケースとエラーハンドリングが文章化されレビュー済み |
| 2. レイヤー足場整備 | 責務分離とテスト容易性の確立 | `FrameBuilder`, `TerminalDriver`, 差分モジュールの骨格実装 | 新規モジュールに対するユニットテストが最低限成立 |
| 3. 段階的実装 & テスト | 機能の段階実装と品質確保 | フル描画 → カラー/デバッグ → アニメーションの順で追加 | 各段階で`snapshot`系テストが緑色になる |
| 4. 品質保証 & リリース | 運用手順とドキュメント更新 | プレビュー用バイナリ、スナップショットテスト、更新ドキュメント | `cargo test` 全緑＋プレビュー手動確認ログが残る |

---

## 🗺️ 実装の進め方

### 1. レンダリング契約定義
- CLIレンダラーの入力: `CliGameState`, フレームヒント、アニメーションキュー
- 出力: ターミナル描画コマンド列 or フレームバッファ
- 想定エッジケース: 空ボード、急速入力、アニメーション重複、色表示OFF、端末リサイズ、描画失敗時の復旧
- 設計上の制約: 一般的なテトリスのUI/演出を参考にせず、旧CLI版の表示仕様・レイアウトをそのまま継承する
- 成果物: `PHASE2D_CONTEXT_RECOVERY.md` または新規ノートに反映

### 2. レイヤー足場整備
- `FrameBuilder`: Core状態から抽象フレーム (`Frame { rows, overlays, debug }`) を生成
- `TerminalDriver`: crossterm依存を隔離し、カーソル制御・バッファフラッシュを担当
- 差分コンポーネント: 直前フレームとの比較により再描画範囲を算出
- 早期にユニットテストを追加し、ロジック部分を端末依存から切り離す

### 3. 段階的実装と検証
1. **決定論的フルレンダリング**: 既存Phase 2C表示を再現。スナップショットテストでゴールデンフレームを固定
2. **カラー設定 & デバッグ情報**: 設定フラグで分岐させ、テストでON/OFFを保証
3. **アニメーション統合**: タイムライン管理とフォールバック挙動を検証

### 4. 品質保証とリリース準備
- プレビュー用途の軽量バイナリ (例: `main_cli_preview.rs`) を追加し、手動確認ルートを確保
- `insta` などのスナップショットテストライブラリ導入を検討
- `PROJECT_STATUS.md`, `HISTORY.md`, `PHASE2C_LEARNING_LOG.md` など関連文書を更新
- 完了後に `phase2d-completed` タグ付与とPhase 3計画再開

---

## 🧭 推奨トラッキング方法

### GitHub Issues
- Issueテンプレート例:
    ```markdown
    # [Phase 2D-01] レンダリング契約定義

    ## ゴール
    - 入出力境界を整理し、主要ユースケースとエラーモードをリスト化
    - ドキュメントへ反映

    ## 成功条件
    - [ ] 想定エッジケースと失敗時ハンドリングが明文化されている
    - [ ] レビューで承認済み
    ```
- ラベル: `phase-2d`, `renderer`, `design`, `testing`, `risk-medium`

### プロジェクトボード (Kanban)
```
📋 Backlog → � Design → 🛠️ Implementation → 🧪 Testing → ✅ Done
```
- カード例: 「Phase 2D-02: FrameBuilder骨格実装 (1.0日)」

### 軽量TODO
```markdown
## 現在進行中
- [ ] Phase 2D-01: レンダリング契約定義

## 次タスク
- [ ] Phase 2D-02: FrameBuilder骨格
- [ ] Phase 2D-03: TerminalDriverプロトタイプ
- [ ] Phase 2D-04: スナップショットテスト導入

## 完了
- [x] Phase 2C完了及び安定ライン復元
```

---

## ✅ 着手前チェックリスト

### 環境
- [ ] `git status` が clean
- [ ] `git branch` で作業ブランチ (例: `feature/phase2d-renderer-rewrite`) を用意
- [ ] `cargo check --lib` / `cargo test --lib` が成功

### ドキュメント
- [ ] `PROJECT_STATUS.md`, `HISTORY.md` の最新化を確認
- [ ] `PHASE2C_LEARNING_LOG.md` / `PHASE2D_CONTEXT_RECOVERY.md` を参照
- [ ] 既存レンダリング仕様 (Phase 2C) と差分を整理

### ツール
- [ ] `cargo insta` 等スナップショットテストツールの導入方針確定
- [ ] `cargo watch -x "test renderer"` など継続テスト手段の検討
- [ ] 端末依存挙動をロギングする軽量ユーティリティの準備

---

## 🧪 推奨テスト戦略
- **ユニットテスト**: FrameBuilderロジック、差分計算、設定フラグ分岐
- **スナップショットテスト**: 代表的なボード状態・UI表示を固定
- **統合テスト**: ターミナルドライバの擬似端末経由確認 (必要に応じて feature flag で分離)
- **手動検証**: プレビュー用バイナリで実際の端末描画を確認し、エスケープシーケンスの不備を洗い出す

---

## 📈 進捗指標
- **テスト緑率**: `cargo test` / スナップショットテストが常時緑
- **ドキュメント同期**: マイルストーン完了時に関連文書が更新されていること
- **リスクログ**: 新規発生リスクが `MIGRATION_RISK_COMPREHENSIVE_ANALYSIS.md` に追記されていること
- **レビュー回数**: 各マイルストーンで最低1回のレビューを経ていること

---

## 🏁 完了条件 (Phase 2D)
- 新CLIレンダラーが `main_phase2c.rs` 互換の描画出力を達成
- 差分描画とアニメーションが再導入され、スナップショットテストで保護されている
- ドキュメント (`PROJECT_STATUS.md`, `HISTORY.md`, `IMPLEMENTATION_ROADMAP.md`, 関連ログ) が更新済み
- `phase2d-completed` タグを付与し、Phase 3 (WASM境界最終統合) に進む準備が整う

**安定したPhase 2C基盤を守りながら、段階的にPhase 2Dを再構築してください。**