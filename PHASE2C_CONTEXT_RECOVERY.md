# THUD&TILE Phase 2C コンテキスト回復プロンプト

## プロジェクト概要
**目標**: RustテトリスゲームのWASM統合 - Phase 2C: CLI描画システム統合
**現在のフェーズ**: Phase 2C (CLI Rendering統合) 
**前フェーズ**: Phase 2B (CLI Input統合) ✅ 完了済み

## プロジェクト進行状況

### ✅ 完了済みフェーズ
1. **Phase 1**: Vec to fixed-array変換 (完了: `phase1-completed`)
2. **Phase 2A**: CLI Layer基盤作成 (完了: `phase2a-completed`)
3. **Phase 2B**: CLI Input統合マッピング (完了: `phase2b-completed`)

### 🎯 現在のフェーズ
**Phase 2C**: CLI描画システム統合
- **目標**: CLI Layer描画機能とゲーム状態の完全統合
- **期間**: 2025年10月8日開始予定
- **前提条件**: Phase 2Bで確立した入力処理基盤を活用

## 技術状況

### アーキテクチャ (Phase 2B完了時点)
```
Core Layer (src/core/)     - ゲームロジック・状態管理
    ↓
CLI Layer (src/cli/)       - CLI特化機能・入力処理・描画システム  
    ↓
Main Layer (main_*.rs)     - メインプログラム
```

**重要原則**: Main LayerはCLI Layerのみ使用、適切なレイヤー分離維持

### Phase 2B完了時の CLI Layer構造
```
src/cli/
├── mod.rs                        # CLI Layer公開API (CoreGameEvent再公開)
├── cli_game_state.rs            # CLI特化ゲーム状態管理 + start_playing_mode()
├── cli_animation.rs             # CLI特化アニメーション
├── cli_input_handler_simple.rs  # ✅ リアルタイム入力処理完成
└── cli_renderer_simple.rs       # 🎯 Phase 2C拡張対象
```

### Phase 2B達成事項
- ✅ WASDキー + 矢印キー完全対応
- ✅ ゲームモード状態管理（Title/Playing/GameOver）
- ✅ GameInput → CoreGameEvent変換パイプライン
- ✅ リアルタイム非ブロッキング入力処理
- ✅ 入力統計・デバッグ機能

## Phase 2C 実装対象

### 1. CLI描画システム拡張
**対象ファイル**: `src/cli/cli_renderer_simple.rs` (拡張)
**現在の状況**: 基本フレームワークのみ実装済み
**要件**:
- ゲームボード描画の完全実装
- 現在ピース描画の統合
- スコア・統計情報表示
- アニメーション状態の視覚化

### 2. CliGameStateとの描画統合
**統合先**: `src/cli/cli_game_state.rs`との連携強化
**要件**:
- `needs_redraw()`フラグを活用した効率的描画
- アニメーション状態の適切な描画反映
- フレーム更新との同期

### 3. リアルタイム描画ループ
**対象**: 新規`main_phase2c.rs`作成
**参考**: `main_phase2b.rs`の入力処理基盤を継承
**要件**:
- 入力処理 + 描画更新の統合ループ
- パフォーマンス監視（FPS、描画回数等）
- ユーザーフレンドリーなゲーム体験

### 4. 色彩・視覚表現
**要件**:
- 3色システム（シアン、マゼンタ、イエロー）の適切な表現
- ANSI色彩コードの活用
- テキストベースでの直感的なゲーム表示

## Phase 2B 学習成果の活用

### 1. 段階的実装手法（継続）
- 小単位でのコンパイル確認
- エラー1つずつ確実解決
- 中間動作確認の重要性

### 2. アーキテクチャ原則（継続）
- CLI Layer経由でのアクセス徹底
- 独立した機能モジュール設計
- 正しいレイヤー分離維持

### 3. デバッグ手法（活用）
- 段階的確認：コンパイル→実行→描画→統合
- 統計情報活用：フレーム数、描画回数、パフォーマンス
- 条件付きデバッグメッセージで情報過多防止

### 4. テスト駆動開発（継続）
- 仕様書とテスト内容の乖離チェック
- 早期問題発見のための包括的テスト
- ユーザー・エージェント協力的問題解決

## 開発環境情報

### Gitブランチ・タグ状況
```
Current: feature/wasm-integration-from-complete
Tags: phase1-completed, phase2a-completed, phase2b-completed
Next Tag: phase2c-completed (予定)
```

### 依存関係（Phase 2B時点で確認済み）
```toml
crossterm = "0.27"          # ターミナル制御・入力処理・色彩表示
wasm-bindgen = "0.2"        # WASM統合
```

### コンパイル状況
- **現在**: ✅ `cargo check --lib` 成功 (警告のみ)
- **入力処理**: ✅ `main_phase2b` 完全動作確認済み
- **品質**: エラーゼロ、正しいレイヤー分離維持

## Phase 2C 成功指標

### 技術的指標
- [ ] コンパイル成功 (エラーゼロ維持)
- [ ] 基本ゲームボード描画動作
- [ ] ピース移動の視覚的反映  
- [ ] スコア表示システム動作
- [ ] 統合ゲームループ成功

### 品質指標
- [ ] 正しいレイヤー分離維持
- [ ] 描画パフォーマンス確保
- [ ] エラーハンドリング実装
- [ ] テストプログラム完全動作

### ユーザー体験指標
- [ ] 直感的なゲーム表示
- [ ] リアルタイム応答性
- [ ] 色彩による情報伝達
- [ ] プレイアブルなゲーム体験

## 優先実装順序 (Phase 2B学習活用)

1. **基本ボード描画** (低リスク) - CLI Layerの描画基盤
2. **現在ピース表示** (低リスク) - ゲーム状態との基本統合
3. **入力→描画統合** (中リスク) - Phase 2B成果との連携
4. **スコア・UI表示** (中リスク) - 包括的情報表示
5. **アニメーション統合** (中-高リスク) - 高度な視覚効果

## 重要な注意事項

### アーキテクチャ原則（Phase 2B継続）
- Main LayerはCLI Layerのみ使用
- Core Layer直接アクセス禁止維持
- CLI特化機能は`src/cli/`内で完結

### Phase 2B 教訓活用
- 段階的実装でリスク軽減
- 小単位コンパイル確認継続
- ユーザーとの協力的問題解決

### 品質基準（継続）
- エラーゼロ状態維持
- 警告対応は低優先度
- 動作確認を各段階で実施

## Phase 2B → Phase 2C 連携要素

### 活用する既存機能
1. **入力処理基盤**: `CliInputHandler`の完全活用
2. **ゲーム状態管理**: `CliGameState`の描画フラグ活用
3. **テスト手法**: Phase 2Bで確立したデバッグ手法継続

### 拡張する領域
1. **描画システム**: 視覚的ゲーム体験の実現
2. **統合ループ**: 入力 + 描画の完全な統合
3. **ユーザー体験**: プレイアブルなゲームの完成

---

**Phase 2B の成功基盤の上に、Phase 2C を着実に実装していきましょう！**

## 開始時の推奨アクション
1. 現在の`cli_renderer_simple.rs`内容確認
2. Phase 2C用のTODOリスト作成  
3. 基本ボード描画機能の実装開始